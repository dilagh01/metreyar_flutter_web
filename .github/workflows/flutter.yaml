name: Flutter Setup & Deploy to GitHub Pages

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.22.1'
          channel: stable
          architecture: x64

      - name: Create minimal Flutter project if not exists
        run: |
          mkdir -p lib web android

          if [ ! -f "pubspec.yaml" ]; then
            cat <<'EOF' > pubspec.yaml
name: metreyar_flutter_web
description: A new Flutter project.
publish_to: 'none'
version: 1.0.0+1

environment:
  sdk: '>=3.3.0 <4.0.0'

dependencies:
  flutter:
    sdk: flutter

dev_dependencies:
  flutter_test:
    sdk: flutter

flutter:
  uses-material-design: true
EOF
          fi

          if [ ! -f "lib/main.dart" ]; then
            cat <<'EOF' > lib/main.dart
import 'package:flutter/material.dart';

void main() {
  runApp(const MyApp());
}

class MyApp extends StatelessWidget {
  const MyApp({super.key});

  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      home: Scaffold(
        appBar: AppBar(title: const Text('Hello Flutter Web & Android')),
        body: const Center(child: Text('Welcome to Flutter Web and Android!')),
      ),
    );
  }
}
EOF
          fi

          if [ ! -f "web/index.html" ]; then
            cat <<'EOF' > web/index.html
<!DOCTYPE html>
<html>
<head>
  <meta charset='UTF-8'>
  <title>Flutter Web</title>
  <link rel='manifest' href='manifest.json'>
</head>
<body>
  <script src='main.dart.js'></script>
</body>
</html>
EOF
          fi

      - name: Get dependencies
        run: flutter pub get

      - name: Build Flutter Web
        run: flutter build web

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: build/web
